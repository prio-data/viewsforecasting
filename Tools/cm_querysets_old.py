
# # Specifying querysets for use in Predicting Fatalities project
# Fatalities002 version
# ## cm level
# 
# 

# ## Importing modules


# Basics
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.cbook as cbook
# sklearn
from sklearn.ensemble import RandomForestRegressor
from sklearn import linear_model
# Views 3
from viewser.operations import fetch
from viewser import Queryset, Column
import views_runs
from views_partitioning import data_partitioner, legacy
from stepshift import views

#FAO AQUASTAT queryset
#time lag 48 month

qs_aquastat = (Queryset("fatalities002_aquastat_stub", "country_month")

         
    #Agricultural water withdrawal as % of total renewable water resources [%]
    .with_column(Column('agr_withdrawal_pct', from_table = 'fao_aqua_cy', from_column = 'agr_withdrawal_pct')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('agr_withdrawal_pct_t48', from_table = 'fao_aqua_cy', from_column = 'agr_withdrawal_pct') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
      
    #Dam capacity per capita [m3/inhab]
    .with_column(Column('dam_cap_pcap', from_table = 'fao_aqua_cy', from_column = 'dam_cap_pcap')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('dam_cap_pcap_t48', from_table = 'fao_aqua_cy', from_column = 'dam_cap_pcap') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
      
    #Groundwater: leaving the country to other countries (total) [10^9 m3/year]
    .with_column(Column('groundwater_export', from_table = 'fao_aqua_cy', from_column = 'groundwater_export')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('groundwater_export_t48', from_table = 'fao_aqua_cy', from_column = 'groundwater_export') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
      
    #MDG 7.5. Freshwater withdrawal as % of total renewable water resources [%]
    .with_column(Column('fresh_withdrawal_pct', from_table = 'fao_aqua_cy', from_column = 'fresh_withdrawal_pct')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('fresh_withdrawal_pct_t48', from_table = 'fao_aqua_cy', from_column = 'fresh_withdrawal_pct') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    #SDG 6.4.1. Industrial Water Use Efficiency [US$/m3]
    .with_column(Column('ind_efficiency', from_table = 'fao_aqua_cy', from_column = 'ind_efficiency')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('ind_efficiency_t48', from_table = 'fao_aqua_cy', from_column = 'ind_efficiency') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    #SDG 6.4.1. Irrigated Agriculture Water Use Efficiency [US$/m3]
    .with_column(Column('irr_agr_efficiency', from_table = 'fao_aqua_cy', from_column = 'irr_agr_efficiency')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('irr_agr_efficiency_t48', from_table = 'fao_aqua_cy', from_column = 'irr_agr_efficiency') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    #SDG 6.4.1. Services Water Use Efficiency [US$/m3]
    .with_column(Column('services_efficiency', from_table = 'fao_aqua_cy', from_column = 'services_efficiency')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('services_efficiency_t48', from_table = 'fao_aqua_cy', from_column = 'services_efficiency') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    #SDG 6.4.1. Water Use Efficiency [US$/m3]
    .with_column(Column('general_efficiency', from_table = 'fao_aqua_cy', from_column = 'general_efficiency')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('general_efficiency_t48', from_table = 'fao_aqua_cy', from_column = 'general_efficiency') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    #SDG 6.4.2. Water Stress [%]
    .with_column(Column('water_stress', from_table = 'fao_aqua_cy', from_column = 'water_stress')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('water_stress_t48', from_table = 'fao_aqua_cy', from_column = 'water_stress') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    #Total internal renewable water resources per capita [m3/inhab/yr]      
    .with_column(Column('renewable_internal_pcap', from_table = 'fao_aqua_cy', from_column = 'renewable_internal_pcap')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('renewable_internal_pcap_t48', from_table = 'fao_aqua_cy', from_column = 'renewable_internal_pcap') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    #Total annual renewable water resources per capita [m3/inhab/year]
    .with_column(Column('renewable_pcap', from_table = 'fao_aqua_cy', from_column = 'renewable_pcap')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('renewable_pcap_t48', from_table = 'fao_aqua_cy', from_column = 'renewable_pcap') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(48)
                .transform.missing.fill())
    
        .with_theme("fatalities")
        .describe("""Predicting ln(fatalities), cm level

        Queryset based on the FAO AQUASTAT data

    """)
        )

data = qs_aquastat.publish().fetch()

print(f"fatalities002_aquastat_stub; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


################

qs_baseline = (Queryset("fatalities002_baseline", "country_month")

    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   

    # timelag 0 of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )


     # From WDI
        .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                     .transform.missing.fill()
                     .transform.temporal.tlag(12)
                     .transform.missing.fill()
                    )

        .with_theme("fatalities")
        .describe("""Fatalities conflict history, cm level

            Predicting ln(fatalities) using conflict predictors, ultrashort

        """)
    )
#data = qs_baseline.publish().fetch()

#print(f"fatalities002_baseline; "
#      f"A dataset with {len(data.columns)} columns, with "
#      f"data between t {min(data.index.get_level_values(0))} "
#      f"and {max(data.index.get_level_values(0))}. "
#      f"({len(np.unique(data.index.get_level_values(1)))} units)"
#     )


#Mueller & Rauh topic model features
#tlag 1 variables

qs_topics = (Queryset("fatalities002_topic", "country_month")

         
    #Topic 0, religious tensions: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic0_religion', from_table = 'topic_cm', from_column = 'topic_religion')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic0_religion_t1', from_table='topic_cm', from_column = 'topic_religion') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic0_religion_t1_stock', from_table='topic_cm', from_column = 'topic_religion') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    
    #Topic 1, politics, original: tlag1, 12 month moving average on tlag1
    .with_column(Column('topic1_politics', from_table = 'topic_cm', from_column = 'topic_politics')
                .transform.missing.fill()
                .transform.missing.replace_na()
                )
    .with_column(Column('topic1_politics_t1', from_table='topic_cm', from_column = 'topic_politics') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic1_politics_t1_stock', from_table='topic_cm', from_column = 'topic_politics') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    
    #Topic 2, diplomacy and sanctions: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic2_sanctions', from_table = 'topic_cm', from_column = 'topic_sanctions')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic2_sanctions_t1', from_table='topic_cm', from_column = 'topic_sanctions') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic2_sanctions_t1_stock', from_table='topic_cm', from_column = 'topic_sanctions') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 3, civilian life: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic3_life', from_table = 'topic_cm', from_column = 'topic_life')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic3_life_t1', from_table='topic_cm', from_column = 'topic_life') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic3_life_t1_stock', from_table='topic_cm', from_column = 'topic_life') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 4, energy and industry: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic4_energy', from_table = 'topic_cm', from_column = 'topic_energy')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic4_energy_t1', from_table='topic_cm', from_column = 'topic_energy') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic4_energy_t1_stock', from_table='topic_cm', from_column = 'topic_energy') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 5, media and reporting: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic5_media', from_table = 'topic_cm', from_column = 'topic_media')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic5_media_t1', from_table='topic_cm', from_column = 'topic_media') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic5_media_t1_stock', from_table='topic_cm', from_column = 'topic_media') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 6, economics: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic6_economics', from_table = 'topic_cm', from_column = 'topic_economics')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic6_economics_t1', from_table='topic_cm', from_column = 'topic_economics') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic6_economics_t1_stock', from_table='topic_cm', from_column = 'topic_economics') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 7, health and emergencies: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic7_health', from_table = 'topic_cm', from_column = 'topic_health')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic7_health_t1', from_table='topic_cm', from_column = 'topic_health') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic7_health_t1_stock', from_table='topic_cm', from_column = 'topic_health') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 8, chinese politics: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic8_china', from_table = 'topic_cm', from_column = 'topic_china')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic8_china_t1', from_table='topic_cm', from_column = 'topic_china') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic8_china_t1_stock', from_table='topic_cm', from_column = 'topic_china') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 9, foreign policy: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic9_foreign', from_table = 'topic_cm', from_column = 'topic_foreign')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic9_foreign_t1', from_table='topic_cm', from_column = 'topic_foreign') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic9_foreign_t1_stock', from_table='topic_cm', from_column = 'topic_foreign') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 10, armed conflict: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic10_conflict', from_table = 'topic_cm', from_column = 'topic_conflict')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic10_conflict_t1', from_table='topic_cm', from_column = 'topic_conflict') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic10_conflict_t1_stock', from_table='topic_cm', from_column = 'topic_conflict') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 11, diplomacy: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic11_diplomacy', from_table = 'topic_cm', from_column = 'topic_diplomacy')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic11_diplomacy_t1', from_table='topic_cm', from_column = 'topic_diplomacy') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic11_diplomacy_t1_stock', from_table='topic_cm', from_column = 'topic_diplomacy') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 12, power and negotiation: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic12_power', from_table = 'topic_cm', from_column = 'topic_power')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic12_power_t1', from_table='topic_cm', from_column = 'topic_power') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic12_power_t1_stock', from_table='topic_cm', from_column = 'topic_power') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 13, sports: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic13_sports', from_table = 'topic_cm', from_column = 'topic_sports')
                .transform.missing.fill()
                 .transform.missing.replace_na()
                )
    .with_column(Column('topic13_sports_t1', from_table='topic_cm', from_column = 'topic_sports') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic13_sports_t1_stock', from_table='topic_cm', from_column = 'topic_sports') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
    #Topic 14, judiciary and abuses: original, tlag1, 12 month moving average on tlag1
    .with_column(Column('topic14_judiciary', from_table = 'topic_cm', from_column = 'topic_judiciary')
                .transform.missing.fill()
                .transform.missing.replace_na()
                )
    .with_column(Column('topic14_judiciary_t1', from_table='topic_cm', from_column = 'topic_judiciary') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill())
    .with_column(Column('topic14_judiciary_t1_stock', from_table='topic_cm', from_column = 'topic_judiciary') 
                .transform.missing.fill()
                .transform.missing.replace_na()
                .transform.temporal.tlag(1)
                .transform.missing.fill()
                .transform.temporal.moving_average(12)
                .transform.missing.fill()
                )
        .with_theme("fatalities")
        .describe("""Predicting ln(fatalities), cm level

        Queryset with Mueller & Rauh topic model features

    """)
        )

data = qs_topics.publish().fetch()

print(f"fatalities002_topic_stub; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )

# Topics model and baseline





# ## Long conflict history model


# With acled2_cm version, ln versions of predictors
# log variables
qs = (Queryset("hh_fatalities_ged_acled_ln", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                  

    # timelags 0-6 of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_sb_tlag_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_2", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_3", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(3)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_4", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(4)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(5)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_6", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(6)
                 .transform.missing.fill()
                )
    # Spatial lags
    .with_column(Column("splag_1_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.spatial.countrylag(1,1,0,0)
                )
    .with_column(Column("splag_2_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.spatial.countrylag(1,2,0,0)
                )
    .with_column(Column("splag_1_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.spatial.countrylag(1,1,0,0)
                )
    .with_column(Column("splag_1_ged_ns", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.spatial.countrylag(1,1,0,0)
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(1)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )

    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_25", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(25)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_500", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(500)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # os
    .with_column(Column("decay_ged_os_1", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(1)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_25", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(25)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_100", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_500", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(500)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # ns
    .with_column(Column("decay_ged_ns_1", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(1)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_25", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(25)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_100", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_500", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(500)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
        )
    # Spatial lags of decays
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
    )
    .with_column(Column("splag_1_decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_os_100", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_ns_100", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
    )



    # Other independent variables
    .with_column(Column("ln_ged_ns", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_count", from_table = "acled2_cm", from_column = "acled_sb_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_prx_count", from_table = "acled2_cm", from_column = "acled_prx_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_pr_count", from_table = "acled2_cm", from_column = "acled_pr_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_prx_fat", from_table = "acled2_cm", from_column = "acled_prx_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_gov", from_table = "acled2_cm", from_column = "acled_bat_gov_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_reb", from_table = "acled2_cm", from_column = "acled_bat_reb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_ns", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_os", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )

    # time-lagged by 0-2 independent variables
    .with_column(Column("ln_ged_ns_tlag_1", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )               
    .with_column(Column("ln_ged_ns_tlag_2", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_os_tlag_1", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_os_tlag_2", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_tlag_1", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_tlag_2", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_os_tlag_1", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_os_tlag_2", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_ns_tlag_1", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_ns_tlag_2", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )


    # 12-month decay dummy of independent variables
    .with_column(Column("decay_acled_sb_5", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_os_5", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_ns_5", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
            )
 # From WDI
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    .with_theme("fatalities")
    .describe("""Fatalities conflict history, cm level

        Predicting ln(fatalities) using conflict predictors

    """)
)
data = qs.publish().fetch()

print(f"hh_fatalities_ged_acled_ln; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# ## Shorter conflict history model


# With acled2_cm version, ln versions of predictors
# log variables

qs = (Queryset("fat_cm_conflict_history", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                  
       
    # timelags 0-6 of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_sb_tlag_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_2", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_3", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(3)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_4", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(4)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(5)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_6", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(6)
                 .transform.missing.fill()
                )

    # Decay functions
    # sb

    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_500", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(500)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # os
             
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_100", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # ns
    .with_column(Column("decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_100", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )

    # Other independent variables
    .with_column(Column("ln_ged_ns", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_count", from_table = "acled2_cm", from_column = "acled_sb_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_os", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )

    # time-lagged by 0-2 independent variables
    .with_column(Column("ln_ged_os_tlag_1", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )

    .with_column(Column("decay_acled_sb_5", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_os_5", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_ns_5", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # Spatial lags of decay functions
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
    )
             

    # gwnos
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
            )

         # From WDI
            .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )

            .with_theme("fatalities")
            .describe("""Fatalities conflict history, cm level

                Predicting ln(fatalities) using conflict predictors

            """)
        )
data = qs.publish().fetch()

print(f"fat_cm_conflict_history; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )



# # Varieties of democracy querysets

# ## vdem_broad

# With vdem and wdi, long version
# log variables
qs = (Queryset("hh_fatalities_vdem", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   


    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )


    # Features from vdem
    .with_column(Column("vdem_v2x_delibdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_delibdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_egaldem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_egaldem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_libdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_libdem_48", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(60)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_partip", from_table = "vdem_v11_cy", from_column = "vdem_v2x_partip")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_partipdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_partipdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_polyarchy", from_table = "vdem_v11_cy", from_column = "vdem_v2x_polyarchy")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
#            .with_column(Column("vdem_v2x_api", from_table = "vdem_v11_cy", from_column = "vdem_v2x_api")
#                         .transform.missing.fill()
#                         .transform.temporal.tlag(12)
#                         .transform.missing.fill()
#                        )
#            .with_column(Column("vdem_v2x_civlib", from_table = "vdem_v11_cy", from_column = "vdem_v2x_civlib")
#                         .transform.missing.fill()
#                         .transform.temporal.tlag(12)
#                         .transform.missing.fill()
#                        )
    .with_column(Column("vdem_v2x_clphy", from_table = "vdem_v11_cy", from_column = "vdem_v2x_clphy")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_clpol", from_table = "vdem_v11_cy", from_column = "vdem_v2x_clpol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_clpriv", from_table = "vdem_v11_cy", from_column = "vdem_v2x_clpriv")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_cspart", from_table = "vdem_v11_cy", from_column = "vdem_v2x_cspart")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_diagacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_diagacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_divparctrl", from_table = "vdem_v11_cy", from_column = "vdem_v2x_divparctrl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_edcomp_thick", from_table = "vdem_v11_cy", from_column = "vdem_v2x_edcomp_thick")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_egal", from_table = "vdem_v11_cy", from_column = "vdem_v2x_egal")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_elecoff", from_table = "vdem_v11_cy", from_column = "vdem_v2x_elecoff")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_execorr", from_table = "vdem_v11_cy", from_column = "vdem_v2x_execorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_feduni", from_table = "vdem_v11_cy", from_column = "vdem_v2x_feduni")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_frassoc_thick", from_table = "vdem_v11_cy", from_column = "vdem_v2x_frassoc_thick")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_gencs", from_table = "vdem_v11_cy", from_column = "vdem_v2x_gencs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_gencl", from_table = "vdem_v11_cy", from_column = "vdem_v2x_gencl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_gender", from_table = "vdem_v11_cy", from_column = "vdem_v2x_gender")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_genpp", from_table = "vdem_v11_cy", from_column = "vdem_v2x_genpp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_horacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_horacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_hosabort", from_table = "vdem_v11_cy", from_column = "vdem_v2x_hosabort")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_hosinter", from_table = "vdem_v11_cy", from_column = "vdem_v2x_hosinter")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_jucon", from_table = "vdem_v11_cy", from_column = "vdem_v2x_jucon")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_legabort", from_table = "vdem_v11_cy", from_column = "vdem_v2x_legabort")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_mpi", from_table = "vdem_v11_cy", from_column = "vdem_v2x_mpi")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_neopat", from_table = "vdem_v11_cy", from_column = "vdem_v2x_neopat")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_pubcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2x_pubcorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_regime", from_table = "vdem_v11_cy", from_column = "vdem_v2x_regime")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_regime_amb", from_table = "vdem_v11_cy", from_column = "vdem_v2x_regime_amb")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_rule", from_table = "vdem_v11_cy", from_column = "vdem_v2x_rule")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_suffr", from_table = "vdem_v11_cy", from_column = "vdem_v2x_suffr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_veracc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_veracc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_confidence", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_confidence")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_direlect", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_direlect")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_military", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_military")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_hereditary", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_hereditary")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_party", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_party")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_freexp", from_table = "vdem_v11_cy", from_column = "vdem_v2x_freexp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_freexp_altinf", from_table = "vdem_v11_cy", from_column = "vdem_v2x_freexp_altinf")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_acjst", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_acjst")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_disc", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_disc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_prpty", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_prpty")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_slave", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_slave")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcs_ccsi", from_table = "vdem_v11_cy", from_column = "vdem_v2xcs_ccsi")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_cic", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_cic")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_dd", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_dd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_i_ci", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_i_ci")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_i_or", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_i_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_i_pl", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_i_pl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_i_rf", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_i_rf")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_toc", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_toc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdl_delib", from_table = "vdem_v11_cy", from_column = "vdem_v2xdl_delib")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqaccess", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqaccess")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqdr", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqdr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqprotec", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqprotec")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_elecparl", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_elecparl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_elecpres", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_elecpres")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_frefair", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_frefair")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_regelec", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_regelec")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xex_elecleg", from_table = "vdem_v11_cy", from_column = "vdem_v2xex_elecleg")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xlg_elecreg", from_table = "vdem_v11_cy", from_column = "vdem_v2xlg_elecreg")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xex_elecreg", from_table = "vdem_v11_cy", from_column = "vdem_v2xex_elecreg")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xlg_leginter", from_table = "vdem_v11_cy", from_column = "vdem_v2xlg_leginter")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xme_altinf", from_table = "vdem_v11_cy", from_column = "vdem_v2xme_altinf")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_client", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_client")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_pres", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_pres")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_regcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_regcorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlecon", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlecon")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlpol", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlpol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgeo", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgeo")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgender", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgender")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xps_party", from_table = "vdem_v11_cy", from_column = "vdem_v2xps_party")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
                 
 # Spatial lags

    .with_column(Column("splag_vdem_v2x_libdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                        )

    .with_column(Column("splag_vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )
             
 # From REIGN

    .with_column(Column("reign_elected", from_table = "reign_cm", from_column = "elected")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_age", from_table = "reign_cm", from_column = "age")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_tenure_months", from_table = "reign_cm", from_column = "tenure_months")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_anticipation", from_table = "reign_cm", from_column = "anticipation")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_election_now", from_table = "reign_cm", from_column = "election_now")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_election_recent", from_table = "reign_cm", from_column = "election_recent")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_delayed", from_table = "reign_cm", from_column = "delayed")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_irregular", from_table = "reign_cm", from_column = "irregular")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_pt_suc", from_table = "reign_cm", from_column = "pt_suc")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_pt_attempt", from_table = "reign_cm", from_column = "pt_attempt")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_military", from_table = "reign_cm", from_column = "gov_military")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_parliamentary_democracy", from_table = "reign_cm", from_column = "gov_parliamentary_democracy")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_oligarchy", from_table = "reign_cm", from_column = "gov_oligarchy")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_monarchy", from_table = "reign_cm", from_column = "gov_monarchy")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_personal_dictatorship", from_table = "reign_cm", from_column = "gov_personal_dictatorship")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_provisional_civilian", from_table = "reign_cm", from_column = "gov_provisional_civilian")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_provisional_military", from_table = "reign_cm", from_column = "gov_provisional_military")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_gov_warlordism", from_table = "reign_cm", from_column = "gov_warlordism")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
 # From WDI
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
 

    .with_theme("fatalities")
    .describe("""Predicting ln(fatalities), cm level

        Queryset with cy features from vdem, long

    """)
)
#data = qs.publish().fetch()

#print(f"hh_fatalities_vdem; "
#      f"A dataset with {len(data.columns)} columns, with "
#      f"data between t {min(data.index.get_level_values(0))} "
#      f"and {max(data.index.get_level_values(0))}. "
#      f"({len(np.unique(data.index.get_level_values(1)))} units)"
#     )


# ## vdem_short


# With vdem and wdi, shortened version
# log variables
qs = (Queryset("hh_fatalities_vdem_short", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    # Features from vdem
    .with_column(Column("vdem_v2x_delibdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_delibdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_egaldem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_egaldem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_libdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_libdem_48", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(60)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_partip", from_table = "vdem_v11_cy", from_column = "vdem_v2x_partip")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_partipdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_partipdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
#            .with_column(Column("vdem_v2x_civlib", from_table = "vdem_v11_cy", from_column = "vdem_v2x_civlib")
#                         .transform.missing.fill()
#                         .transform.temporal.tlag(12)
#                         .transform.missing.fill()
#                        )
    .with_column(Column("vdem_v2x_clphy", from_table = "vdem_v11_cy", from_column = "vdem_v2x_clphy")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_cspart", from_table = "vdem_v11_cy", from_column = "vdem_v2x_cspart")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_divparctrl", from_table = "vdem_v11_cy", from_column = "vdem_v2x_divparctrl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_edcomp_thick", from_table = "vdem_v11_cy", from_column = "vdem_v2x_edcomp_thick")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_egal", from_table = "vdem_v11_cy", from_column = "vdem_v2x_egal")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_execorr", from_table = "vdem_v11_cy", from_column = "vdem_v2x_execorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_frassoc_thick", from_table = "vdem_v11_cy", from_column = "vdem_v2x_frassoc_thick")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_gencs", from_table = "vdem_v11_cy", from_column = "vdem_v2x_gencs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_gender", from_table = "vdem_v11_cy", from_column = "vdem_v2x_gender")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_genpp", from_table = "vdem_v11_cy", from_column = "vdem_v2x_genpp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_horacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_horacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_neopat", from_table = "vdem_v11_cy", from_column = "vdem_v2x_neopat")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_pubcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2x_pubcorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_rule", from_table = "vdem_v11_cy", from_column = "vdem_v2x_rule")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_veracc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_veracc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_military", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_military")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_party", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_party")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_freexp", from_table = "vdem_v11_cy", from_column = "vdem_v2x_freexp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_acjst", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_acjst")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_prpty", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_prpty")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_slave", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_slave")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_dd", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_dd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdl_delib", from_table = "vdem_v11_cy", from_column = "vdem_v2xdl_delib")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqdr", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqdr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqprotec", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqprotec")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_frefair", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_frefair")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_regelec", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_regelec")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xme_altinf", from_table = "vdem_v11_cy", from_column = "vdem_v2xme_altinf")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_client", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_client")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_regcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_regcorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlecon", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlecon")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlpol", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlpol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgeo", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgeo")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgender", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgender")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xps_party", from_table = "vdem_v11_cy", from_column = "vdem_v2xps_party")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcs_ccsi", from_table = "vdem_v11_cy", from_column = "vdem_v2xcs_ccsi")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_pres", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_pres")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqaccess", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqaccess")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_diagacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_diagacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
                 
# Spatial lags

    .with_column(Column("splag_vdem_v2x_libdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                        )

    .with_column(Column("splag_vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )
 # From WDI
    .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prim_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prim_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
 

    .with_theme("fatalities")
    .describe("""Predicting ln(fatalities), cm level

        Queryset with cy features from vdem, short

    """)
)
data = qs.publish().fetch()

print(f"hh_fatalities_vdem_short; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# ## World Development Indicators querysets

# With wdi, long version
# log variables
qs = (Queryset("hh_fatalities_wdi", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                  

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    # Features from WDI
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_lnd_totl_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_totl_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_lnd_totl_ru_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_totl_ru_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_srf_totl_k2", from_table = "wdi_cy", from_column = "wdi_ag_srf_totl_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_dt_oda_odat_pc_zs", from_table = "wdi_cy", from_column = "wdi_dt_oda_odat_pc_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ic_bus_ease_xq", from_table = "wdi_cy", from_column = "wdi_ic_bus_ease_xq")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_gd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_gd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kd", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_cn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_cn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_gnp_mktp_pp_kd", from_table = "wdi_cy", from_column = "wdi_ny_gnp_mktp_pp_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_gdp_mktp_kd", from_table = "wdi_cy", from_column = "wdi_ny_gdp_mktp_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_adj_dfor_cd", from_table = "wdi_cy", from_column = "wdi_ny_adj_dfor_cd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prim_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prim_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_sec_nenr", from_table = "wdi_cy", from_column = "wdi_se_sec_nenr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prsc_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prsc_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_maln_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_maln_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_h2o_basw_zs", from_table = "wdi_cy", from_column = "wdi_sh_h2o_basw_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_stnt_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_stnt_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_wash_p5", from_table = "wdi_cy", from_column = "wdi_sh_sta_wash_p5")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    .with_column(Column("wdi_sl_uem_neet_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_neet_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_advn_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_advn_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_neet_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_neet_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_advn_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_advn_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_advn_ma_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_advn_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_totl_zs", from_table = "wdi_cy", from_column = "wdi_sm_pop_totl_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_tfrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_tfrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_fe_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_fe_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_dyn_mort_fe", from_table = "wdi_cy", from_column = "wdi_sh_dyn_mort_fe")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_0014_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_0014_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_0014_ma_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_0014_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_1564_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_1564_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_1564_ma_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_1564_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_65up_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_65up_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_65up_ma_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_65up_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    .with_column(Column("wdi_sp_pop_dpnd", from_table = "wdi_cy", from_column = "wdi_sp_pop_dpnd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_grow", from_table = "wdi_cy", from_column = "wdi_sp_pop_grow")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_urb_totl_in_zs", from_table = "wdi_cy", from_column = "wdi_sp_urb_totl_in_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )


    # Spatial lags
    .with_column(Column("splag_wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )

         
            .with_theme("fatalities")
            .describe("""Predicting ln(fatalities), cm level

                Queryset with cy features from wdi, long version

            """)
        )
#data = qs.publish().fetch()

#print(f"hh_fatalities_wdi;"
#      f"A dataset with {len(data.columns)} columns, with "
#      f"data between t {min(data.index.get_level_values(0))} "
#      f"and {max(data.index.get_level_values(0))}. "
#      f"({len(np.unique(data.index.get_level_values(1)))} units)"
#     )



# ## wdi_short

# With wdi, short version
# log variables
qs = (Queryset("hh_fatalities_wdi_short", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                  

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )

    # Features from WDI
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_dt_oda_odat_pc_zs", from_table = "wdi_cy", from_column = "wdi_dt_oda_odat_pc_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_gd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_gd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kd", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_gdp_mktp_kd", from_table = "wdi_cy", from_column = "wdi_ny_gdp_mktp_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prim_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prim_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prsc_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prsc_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_maln_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_maln_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_stnt_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_stnt_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_totl_zs", from_table = "wdi_cy", from_column = "wdi_sm_pop_totl_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
#            .with_column(Column("wdi_sp_dyn_tfrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_tfrt_in")
#                         .transform.missing.fill()
#                         .transform.temporal.tlag(12)
#                         .transform.missing.fill()
#                        )
    .with_column(Column("wdi_sp_dyn_imrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_dyn_mort_fe", from_table = "wdi_cy", from_column = "wdi_sh_dyn_mort_fe")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_0014_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_0014_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_1564_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_1564_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_65up_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_65up_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_grow", from_table = "wdi_cy", from_column = "wdi_sp_pop_grow")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_urb_totl_in_zs", from_table = "wdi_cy", from_column = "wdi_sp_urb_totl_in_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
         

    # Spatial lags
    .with_column(Column("splag_wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )


 
    .with_theme("fatalities")
    .describe("""Predicting ln(fatalities), cm level

        Queryset with cy features from wdi, short version

    """)
)
data = qs.publish().fetch()

print(f"hh_fatalities_wdi_short; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# ## Mueller and Rauh topic model features


# Topic model features, long version

qs = (Queryset("hh_topic_model", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )      

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    # Other independent variables
    .with_column(Column("ln_ged_ns", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_count", from_table = "acled2_cm", from_column = "acled_sb_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_prx_count", from_table = "acled2_cm", from_column = "acled_prx_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_pr_count", from_table = "acled2_cm", from_column = "acled_pr_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_prx_fat", from_table = "acled2_cm", from_column = "acled_prx_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_gov", from_table = "acled2_cm", from_column = "acled_bat_gov_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_reb", from_table = "acled2_cm", from_column = "acled_bat_reb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_ns", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_os", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )

    # Features from Muller & Rauh
    .with_column(Column("ste_theta0", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta0_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
         .transform.missing.fill()
         .transform.temporal.tlag(12)
         .transform.missing.replace_na()
        )
    .with_column(Column("ste_theta1", from_table = "topic_model_shares_cm", from_column = "ste_theta1")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2", from_table = "topic_model_shares_cm", from_column = "ste_theta2")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta0_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
         .transform.missing.fill()
         .transform.temporal.tlag(12)
         .transform.missing.replace_na()
        )
    .with_column(Column("ste_theta3", from_table = "topic_model_shares_cm", from_column = "ste_theta3")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4", from_table = "topic_model_shares_cm", from_column = "ste_theta4")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5", from_table = "topic_model_shares_cm", from_column = "ste_theta5")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6", from_table = "topic_model_shares_cm", from_column = "ste_theta6")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7", from_table = "topic_model_shares_cm", from_column = "ste_theta7")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta8", from_table = "topic_model_shares_cm", from_column = "ste_theta8")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9", from_table = "topic_model_shares_cm", from_column = "ste_theta9")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10", from_table = "topic_model_shares_cm", from_column = "ste_theta10")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11", from_table = "topic_model_shares_cm", from_column = "ste_theta11")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta11")
         .transform.missing.fill()
         .transform.temporal.tlag(12)
         .transform.missing.replace_na()
        )
    .with_column(Column("ste_theta12", from_table = "topic_model_shares_cm", from_column = "ste_theta12")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13", from_table = "topic_model_shares_cm", from_column = "ste_theta13")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta13")
         .transform.missing.fill()
         .transform.temporal.tlag(12)
         .transform.missing.replace_na()
        )
    .with_column(Column("ste_theta14", from_table = "topic_model_shares_cm", from_column = "ste_theta14")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta14")
         .transform.missing.fill()
         .transform.temporal.tlag(12)
         .transform.missing.replace_na()
        )
    .with_column(Column("ste_theta0_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta0_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta1_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta1_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta3_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta4_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta5_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta6_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta7_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta8_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta8_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta9_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta10_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta12_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("childmortality", from_table = "topic_model_shares_cm", from_column = "childmortality")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy0", from_table = "topic_model_shares_cm", from_column = "democracy0")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy1", from_table = "topic_model_shares_cm", from_column = "democracy1")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy2", from_table = "topic_model_shares_cm", from_column = "democracy2")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy3", from_table = "topic_model_shares_cm", from_column = "democracy3")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy4", from_table = "topic_model_shares_cm", from_column = "democracy4")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy5", from_table = "topic_model_shares_cm", from_column = "democracy5")
                 .transform.missing.fill()
                )
         
    # Spatial lags
    .with_column(Column("splag_ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
 
 # From WDI
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    .with_theme("fatalities")
    .describe("""Predicting ln(fatalities), cm level

        Queryset with Mueller & Rauh topic model features, long version

    """)
)
data = qs.publish().fetch()

print(f"hh_topic_model; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# ## topics_short


# Topic model features, short version

qs = (Queryset("hh_topic_model_short", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )     

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    # Features from vdem
    .with_column(Column("ste_theta0", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2", from_table = "topic_model_shares_cm", from_column = "ste_theta2")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3", from_table = "topic_model_shares_cm", from_column = "ste_theta3")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4", from_table = "topic_model_shares_cm", from_column = "ste_theta4")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5", from_table = "topic_model_shares_cm", from_column = "ste_theta5")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6", from_table = "topic_model_shares_cm", from_column = "ste_theta6")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7", from_table = "topic_model_shares_cm", from_column = "ste_theta7")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9", from_table = "topic_model_shares_cm", from_column = "ste_theta9")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10", from_table = "topic_model_shares_cm", from_column = "ste_theta10")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11", from_table = "topic_model_shares_cm", from_column = "ste_theta11")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12", from_table = "topic_model_shares_cm", from_column = "ste_theta12")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13", from_table = "topic_model_shares_cm", from_column = "ste_theta13")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14", from_table = "topic_model_shares_cm", from_column = "ste_theta14")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta0_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta0_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta3_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta4_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta5_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta6_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta7_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta9_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta10_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta12_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("childmortality", from_table = "topic_model_shares_cm", from_column = "childmortality")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy1", from_table = "topic_model_shares_cm", from_column = "democracy1")
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )                        
          
    # Spatial lags
    .with_column(Column("splag_ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )

    .with_theme("fatalities")
    .describe("""Predicting ln(fatalities), cm level

        Queryset with Mueller & Rauh topic model features, short version

    """)
)
data = qs.publish().fetch()

print(f"hh_topic_model_short; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )




# # All features model

# Model with all predictors from several models

qs = (Queryset("hh_all_features", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                  

    # timelags 0-6 of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_sb_tlag_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_2", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_3", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(3)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_4", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(4)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(5)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_6", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(6)
                 .transform.missing.fill()
                )

    # Decay functions
    # sb

    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # os
             
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_100", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # ns
    .with_column(Column("decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_100", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )

    # Other independent variables
    .with_column(Column("ln_ged_ns", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_count", from_table = "acled2_cm", from_column = "acled_sb_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_os", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )

    # time-lagged by 0-2 independent variables
    .with_column(Column("ln_ged_os_tlag_1", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )

    .with_column(Column("decay_acled_sb_5", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_os_5", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_ns_5", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # Spatial lags of decay functions
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
    )
             

    # gwnos
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
            )




   # Features from WDI
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_lnd_totl_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_totl_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_lnd_totl_ru_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_totl_ru_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ag_srf_totl_k2", from_table = "wdi_cy", from_column = "wdi_ag_srf_totl_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_dt_oda_odat_pc_zs", from_table = "wdi_cy", from_column = "wdi_dt_oda_odat_pc_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ic_bus_ease_xq", from_table = "wdi_cy", from_column = "wdi_ic_bus_ease_xq")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_gd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_gd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kd", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_cn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_cn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_gnp_mktp_pp_kd", from_table = "wdi_cy", from_column = "wdi_ny_gnp_mktp_pp_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_gdp_mktp_kd", from_table = "wdi_cy", from_column = "wdi_ny_gdp_mktp_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_adj_dfor_cd", from_table = "wdi_cy", from_column = "wdi_ny_adj_dfor_cd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prim_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prim_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_sec_nenr", from_table = "wdi_cy", from_column = "wdi_se_sec_nenr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prsc_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prsc_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_maln_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_maln_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_h2o_basw_zs", from_table = "wdi_cy", from_column = "wdi_sh_h2o_basw_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_stnt_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_stnt_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_wash_p5", from_table = "wdi_cy", from_column = "wdi_sh_sta_wash_p5")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    .with_column(Column("wdi_sl_uem_neet_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_neet_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_advn_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_advn_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_neet_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_neet_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_advn_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_advn_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_uem_advn_ma_zs", from_table = "wdi_cy", from_column = "wdi_sl_uem_advn_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_totl_zs", from_table = "wdi_cy", from_column = "wdi_sm_pop_totl_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_tfrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_tfrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_fe_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_fe_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_dyn_mort_fe", from_table = "wdi_cy", from_column = "wdi_sh_dyn_mort_fe")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_0014_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_0014_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_0014_ma_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_0014_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_1564_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_1564_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_1564_ma_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_1564_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_65up_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_65up_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_65up_ma_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_65up_ma_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

    .with_column(Column("wdi_sp_pop_dpnd", from_table = "wdi_cy", from_column = "wdi_sp_pop_dpnd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_grow", from_table = "wdi_cy", from_column = "wdi_sp_pop_grow")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_urb_totl_in_zs", from_table = "wdi_cy", from_column = "wdi_sp_urb_totl_in_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )         

    # Spatial lags
    .with_column(Column("splag_wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )


    # Features from vdem
    .with_column(Column("vdem_v2x_delibdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_delibdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_egaldem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_egaldem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_libdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_partip", from_table = "vdem_v11_cy", from_column = "vdem_v2x_partip")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_partipdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_partipdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
#            .with_column(Column("vdem_v2x_civlib", from_table = "vdem_v11_cy", from_column = "vdem_v2x_civlib")
#                         .transform.missing.fill()
#                         .transform.temporal.tlag(12)
#                         .transform.missing.fill()
#                        )
    .with_column(Column("vdem_v2x_clphy", from_table = "vdem_v11_cy", from_column = "vdem_v2x_clphy")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_cspart", from_table = "vdem_v11_cy", from_column = "vdem_v2x_cspart")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_divparctrl", from_table = "vdem_v11_cy", from_column = "vdem_v2x_divparctrl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_edcomp_thick", from_table = "vdem_v11_cy", from_column = "vdem_v2x_edcomp_thick")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_egal", from_table = "vdem_v11_cy", from_column = "vdem_v2x_egal")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_execorr", from_table = "vdem_v11_cy", from_column = "vdem_v2x_execorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_frassoc_thick", from_table = "vdem_v11_cy", from_column = "vdem_v2x_frassoc_thick")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_gencs", from_table = "vdem_v11_cy", from_column = "vdem_v2x_gencs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_gender", from_table = "vdem_v11_cy", from_column = "vdem_v2x_gender")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_genpp", from_table = "vdem_v11_cy", from_column = "vdem_v2x_genpp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_horacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_horacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_neopat", from_table = "vdem_v11_cy", from_column = "vdem_v2x_neopat")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_pubcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2x_pubcorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_rule", from_table = "vdem_v11_cy", from_column = "vdem_v2x_rule")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_veracc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_veracc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_military", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_military")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_party", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_party")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_freexp", from_table = "vdem_v11_cy", from_column = "vdem_v2x_freexp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_acjst", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_acjst")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_prpty", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_prpty")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_slave", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_slave")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_dd", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_dd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdd_toc", from_table = "vdem_v11_cy", from_column = "vdem_v2xdd_toc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xdl_delib", from_table = "vdem_v11_cy", from_column = "vdem_v2xdl_delib")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqdr", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqdr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqprotec", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqprotec")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_frefair", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_frefair")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xel_regelec", from_table = "vdem_v11_cy", from_column = "vdem_v2xel_regelec")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xme_altinf", from_table = "vdem_v11_cy", from_column = "vdem_v2xme_altinf")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_client", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_client")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_regcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_regcorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlecon", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlecon")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlpol", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlpol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgeo", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgeo")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgender", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgender")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xps_party", from_table = "vdem_v11_cy", from_column = "vdem_v2xps_party")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcs_ccsi", from_table = "vdem_v11_cy", from_column = "vdem_v2xcs_ccsi")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_pres", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_pres")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqaccess", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqaccess")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_diagacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_diagacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("splag_vdem_v2x_libdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                        )

    .with_column(Column("splag_vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )


    # Features from Muller & Rauh
    .with_column(Column("ste_theta0", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta0_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta1", from_table = "topic_model_shares_cm", from_column = "ste_theta1")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2", from_table = "topic_model_shares_cm", from_column = "ste_theta2")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3", from_table = "topic_model_shares_cm", from_column = "ste_theta3")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4", from_table = "topic_model_shares_cm", from_column = "ste_theta4")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5", from_table = "topic_model_shares_cm", from_column = "ste_theta5")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6", from_table = "topic_model_shares_cm", from_column = "ste_theta6")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7", from_table = "topic_model_shares_cm", from_column = "ste_theta7")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta8", from_table = "topic_model_shares_cm", from_column = "ste_theta8")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9", from_table = "topic_model_shares_cm", from_column = "ste_theta9")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10", from_table = "topic_model_shares_cm", from_column = "ste_theta10")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11", from_table = "topic_model_shares_cm", from_column = "ste_theta11")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12", from_table = "topic_model_shares_cm", from_column = "ste_theta12")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13", from_table = "topic_model_shares_cm", from_column = "ste_theta13")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14", from_table = "topic_model_shares_cm", from_column = "ste_theta14")
                 .transform.missing.fill()
                )

    .with_column(Column("ste_theta0_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta0_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta1_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta1_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta3_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta4_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta5_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta6_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta7_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta8_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta8_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta9_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta10_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta12_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                )
    # Spatial lags
    .with_column(Column("splag_ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
          
    # M&R

    .with_column(Column("childmortality", from_table = "topic_model_shares_cm", from_column = "childmortality")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy0", from_table = "topic_model_shares_cm", from_column = "democracy0")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy1", from_table = "topic_model_shares_cm", from_column = "democracy1")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy2", from_table = "topic_model_shares_cm", from_column = "democracy2")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy3", from_table = "topic_model_shares_cm", from_column = "democracy3")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy4", from_table = "topic_model_shares_cm", from_column = "democracy4")
                 .transform.missing.fill()
                )
    .with_column(Column("democracy5", from_table = "topic_model_shares_cm", from_column = "democracy5")
                 .transform.missing.fill()
                )         
    
 # From REIGN

    .with_column(Column("reign_elected", from_table = "reign_cm", from_column = "elected")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_age", from_table = "reign_cm", from_column = "age")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_tenure_months", from_table = "reign_cm", from_column = "tenure_months")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_anticipation", from_table = "reign_cm", from_column = "anticipation")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_election_now", from_table = "reign_cm", from_column = "election_now")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_election_recent", from_table = "reign_cm", from_column = "election_recent")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_delayed", from_table = "reign_cm", from_column = "delayed")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )  
 
    .with_column(Column("reign_irregular", from_table = "reign_cm", from_column = "irregular")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_pt_suc", from_table = "reign_cm", from_column = "pt_suc")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_pt_attempt", from_table = "reign_cm", from_column = "pt_attempt")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )


 
    .with_theme("fatalities")
    .describe("""Predicting ln(fatalities), cm level

        Queryset with many features from various sources, long version

    """)
)
data = qs.publish().fetch()

print(f"hh_all_features; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# # Broad, cross-thematic model



# Model with most important predictors from several models, long version

qs = (Queryset("hh_broad", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )

    # Conflict history
    # timelags 0-6 of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_sb_tlag_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )
        
        
    .with_column(Column("ln_ged_sb_tlag_2", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_3", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(3)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_4", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(4)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(5)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_6", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(6)
                 .transform.missing.fill()
                    )

    # Decay functions
    # sb

    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_500", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(500)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # os

    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_100", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # ns
    .with_column(Column("decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_100", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )

    # Other independent variables
    .with_column(Column("ln_ged_ns", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_sb_count", from_table = "acled2_cm", from_column = "acled_sb_count")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_acled_os", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )

    # time-lagged by 0-2 independent variables
    .with_column(Column("ln_ged_os_tlag_1", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                    )

    .with_column(Column("decay_acled_sb_5", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_os_5", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_ns_5", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # Spatial lags of decay functions
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
       
    # gwnos
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
            )

    # Features from reign
    .with_column(Column("reign_anticipation", from_table = "reign_cm", from_column = "anticipation")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_tenure_months", from_table = "reign_cm", from_column = "tenure_months")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_pt_suc", from_table = "reign_cm", from_column = "pt_suc")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_age", from_table = "reign_cm", from_column = "age")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_election_now", from_table = "reign_cm", from_column = "election_now")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
    .with_column(Column("reign_delayed", from_table = "reign_cm", from_column = "delayed")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )

    # Features from topic model
    .with_column(Column("ste_theta0", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta0_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta1", from_table = "topic_model_shares_cm", from_column = "ste_theta1")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2", from_table = "topic_model_shares_cm", from_column = "ste_theta2")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3", from_table = "topic_model_shares_cm", from_column = "ste_theta3")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4", from_table = "topic_model_shares_cm", from_column = "ste_theta4")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5", from_table = "topic_model_shares_cm", from_column = "ste_theta5")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6", from_table = "topic_model_shares_cm", from_column = "ste_theta6")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7", from_table = "topic_model_shares_cm", from_column = "ste_theta7")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta8", from_table = "topic_model_shares_cm", from_column = "ste_theta8")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9", from_table = "topic_model_shares_cm", from_column = "ste_theta9")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10", from_table = "topic_model_shares_cm", from_column = "ste_theta10")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11", from_table = "topic_model_shares_cm", from_column = "ste_theta11")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12", from_table = "topic_model_shares_cm", from_column = "ste_theta12")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13", from_table = "topic_model_shares_cm", from_column = "ste_theta13")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14", from_table = "topic_model_shares_cm", from_column = "ste_theta14")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta0_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta0_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta1_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta1_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta3_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta4_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta5_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta5_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta6_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta6_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta7_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta7_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta8_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta8_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta9_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta9_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta10_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta12_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                )
      


    # Spatial lags
    .with_column(Column("splag_ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )


 # From WDI
    .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_dt_oda_odat_pc_zs", from_table = "wdi_cy", from_column = "wdi_dt_oda_odat_pc_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_gd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_gd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_grow", from_table = "wdi_cy", from_column = "wdi_sp_pop_grow")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prim_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prim_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_urb_totl_in_zs", from_table = "wdi_cy", from_column = "wdi_sp_urb_totl_in_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_maln_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_maln_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_fe_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_fe_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ny_gdp_mktp_kd", from_table = "wdi_cy", from_column = "wdi_ny_gdp_mktp_kd")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_stnt_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_stnt_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )




    # Spatial lags
    .with_column(Column("splag_wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )

 
 # From Vdem
    .with_column(Column("vdem_v2x_horacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_horacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_client", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_client")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_veracc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_veracc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_divparctrl", from_table = "vdem_v11_cy", from_column = "vdem_v2x_divparctrl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlpol", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlpol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_diagacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_diagacc")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgeo", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgeo")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlgender", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlgender")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_party", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_party")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_genpp", from_table = "vdem_v11_cy", from_column = "vdem_v2x_genpp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqdr", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqdr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_prpty", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_prpty")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqprotec", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqprotec")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_ex_military", from_table = "vdem_v11_cy", from_column = "vdem_v2x_ex_military")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_clphy", from_table = "vdem_v11_cy", from_column = "vdem_v2x_clphy")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2x_hosabort", from_table = "vdem_v11_cy", from_column = "vdem_v2x_hosabort")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_regcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_regcorr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
                       
 # Spatial lags

    .with_column(Column("splag_vdem_v2x_libdem", from_table = "vdem_v11_cy", from_column = "vdem_v2x_libdem")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                        )

    .with_column(Column("splag_vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )


    .with_theme("fatalities")
    .describe("""Predicting ln(fatalities), cm level

        Queryset with many features from various sources, long version

    """)
)
     
data = qs.publish().fetch()

print(f"hh_broad; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# ## broad_short

# In[3]:


# Model with most important predictors from several models, short version

qs = (Queryset("hh_broad_short", "country_month")


            # target variable
            .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                         .transform.ops.ln()
                         .transform.missing.fill()
                        )                   

                # timelags 0-6 of target variable
                .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                             .transform.ops.ln()
                             .transform.missing.fill()
                            )
                .with_column(Column("ln_ged_sb_tlag_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                             .transform.ops.ln()
                             .transform.missing.fill()
                             .transform.temporal.tlag(1)
                             .transform.missing.fill()
                            )

                .with_column(Column("ln_ged_sb_tlag_2", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                             .transform.ops.ln()
                             .transform.missing.fill()
                             .transform.temporal.tlag(2)
                             .transform.missing.fill()
                            )

                .with_column(Column("ln_ged_sb_tlag_3", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                             .transform.ops.ln()
                             .transform.missing.fill()
                             .transform.temporal.tlag(3)
                             .transform.missing.fill()
                            )

                .with_column(Column("ln_ged_sb_tlag_4", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                             .transform.ops.ln()
                             .transform.missing.fill()
                             .transform.temporal.tlag(4)
                             .transform.missing.fill()
                            )

                .with_column(Column("ln_ged_sb_tlag_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                             .transform.ops.ln()
                             .transform.missing.fill()
                             .transform.temporal.tlag(5)
                             .transform.missing.fill()
                            )

                .with_column(Column("ln_ged_sb_tlag_6", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                             .transform.ops.ln()
                             .transform.missing.fill()
                             .transform.temporal.tlag(6)
                             .transform.missing.fill()
                            )

    # Decay functions
    # sb

    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # os
             
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_os_100", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # ns
    .with_column(Column("decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_ns_100", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )

        # Other independent variables
        .with_column(Column("ln_ged_ns", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                     .transform.ops.ln()
                     .transform.missing.fill()
                    )
        .with_column(Column("ln_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                     .transform.ops.ln()
                     .transform.missing.fill()
                    )
        .with_column(Column("ln_acled_sb", from_table = "acled2_cm", from_column = "acled_sb_fat")
                     .transform.ops.ln()
                     .transform.missing.fill()
                    )
        .with_column(Column("ln_acled_sb_count", from_table = "acled2_cm", from_column = "acled_sb_count")
                     .transform.ops.ln()
                     .transform.missing.fill()
                    )
        .with_column(Column("ln_acled_os", from_table = "acled2_cm", from_column = "acled_os_fat")
                     .transform.ops.ln()
                     .transform.missing.fill()
                    )

        # time-lagged by 0-2 independent variables
        .with_column(Column("ln_ged_os_tlag_1", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                     .transform.ops.ln()
                     .transform.missing.fill()
                     .transform.temporal.tlag(1)
                     .transform.missing.fill()
                    )

    .with_column(Column("decay_acled_sb_5", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_os_5", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_acled_ns_5", from_table = "acled2_cm", from_column = "acled_ns_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # Spatial lags of decay functions
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_1_decay_ged_ns_5", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
    )
             



            # Other independent variables
            .with_column(Column("ln_ged_os", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                         .transform.ops.ln()
                         .transform.missing.fill()
                        )
         
         # Features from reign
            .with_column(Column("reign_anticipation", from_table = "reign_cm", from_column = "anticipation")
                         .transform.missing.fill()
                         .transform.missing.replace_na() 
                        )
            # Features from topic model
            .with_column(Column("ste_theta0", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta0_t12", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta1", from_table = "topic_model_shares_cm", from_column = "ste_theta1")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta2", from_table = "topic_model_shares_cm", from_column = "ste_theta2")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta3", from_table = "topic_model_shares_cm", from_column = "ste_theta3")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta4", from_table = "topic_model_shares_cm", from_column = "ste_theta4")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta5", from_table = "topic_model_shares_cm", from_column = "ste_theta5")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta6", from_table = "topic_model_shares_cm", from_column = "ste_theta6")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta7", from_table = "topic_model_shares_cm", from_column = "ste_theta7")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta8", from_table = "topic_model_shares_cm", from_column = "ste_theta8")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta9", from_table = "topic_model_shares_cm", from_column = "ste_theta9")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta10", from_table = "topic_model_shares_cm", from_column = "ste_theta10")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta11", from_table = "topic_model_shares_cm", from_column = "ste_theta11")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta12", from_table = "topic_model_shares_cm", from_column = "ste_theta12")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta13", from_table = "topic_model_shares_cm", from_column = "ste_theta13")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta14", from_table = "topic_model_shares_cm", from_column = "ste_theta14")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta0_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta0_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta1_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta1_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta3_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta3_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta4_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta4_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta5_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta5_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta6_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta6_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta7_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta7_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta8_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta8_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta9_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta9_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta10_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta10_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta12_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta12_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                         .transform.missing.fill()
                        )
            .with_column(Column("ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                         .transform.missing.fill()
                        )
         # From WDI
            .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_dt_oda_odat_pc_zs", from_table = "wdi_cy", from_column = "wdi_dt_oda_odat_pc_zs")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_ms_mil_xpnd_gd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_gd_zs")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_nv_agr_totl_kn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kn")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_sp_pop_grow", from_table = "wdi_cy", from_column = "wdi_sp_pop_grow")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_se_enr_prim_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prim_fm_zs")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_sp_urb_totl_in_zs", from_table = "wdi_cy", from_column = "wdi_sp_urb_totl_in_zs")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("wdi_sp_dyn_imrt_fe_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_fe_in")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )

         
         # From Vdem
            .with_column(Column("vdem_v2x_horacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_horacc")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("vdem_v2xnp_client", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_client")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("vdem_v2x_diagacc", from_table = "vdem_v11_cy", from_column = "vdem_v2x_diagacc")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("vdem_v2xeg_eqdr", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqdr")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("vdem_v2xcl_prpty", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_prpty")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )
            .with_column(Column("vdem_v2xnp_regcorr", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_regcorr")
                         .transform.missing.fill()
                         .transform.temporal.tlag(12)
                         .transform.missing.fill()
                        )

        # gwnos
        .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
                )


            .with_theme("fatalities")
            .describe("""Predicting ged_dummy_sb, cm level

                Queryset with many features from various sources, short version

            """)
        )
#data = qs.publish().fetch()

#print(f"hh_broad_short; "
#      f"A dataset with {len(data.columns)} columns, with "
#      f"data between t {min(data.index.get_level_values(0))} "
#      f"and {max(data.index.get_level_values(0))}. "
#      f"({len(np.unique(data.index.get_level_values(1)))} units)"
#     )


# ## Greatest hits


# Model with most important predictors from several models, 'greatest hits' version

qs = (Queryset("fatalities002_greatest_hits", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   

    # Baseline features: [Greatest hits]
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("ln_ged_sb_tlag_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_2", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_3", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(3)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_4", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(4)
                 .transform.missing.fill()
                )
    # sb [Greatest hits]
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    .with_column(Column("decay_ged_sb_500", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(500)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    
    # os [Greatest hits]
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # ns [Greatest hits]
         
    .with_column(Column("decay_ged_ns_100", from_table = "ged2_cm", from_column = "ged_ns_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # ACLED
    .with_column(Column("ln_acled_sb", from_table = "acled2_cm", from_column = "acled_sb_fat")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    .with_column(Column("decay_acled_os_5", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
         


     # Features from reign [Greatest hits]
        .with_column(Column("reign_tenure_months", from_table = "reign_cm", from_column = "tenure_months")
                     .transform.missing.fill()
                     .transform.missing.replace_na() 
                    )
         
            # Features from topic model [Greatest hits]
    .with_column(Column("ste_theta0", from_table = "topic_model_shares_cm", from_column = "ste_theta0")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14", from_table = "topic_model_shares_cm", from_column = "ste_theta14")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta3_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta4_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta4_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta10_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta10_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta12_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta12_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                )
         

    # Spatial lags [Greatest hits]
    .with_column(Column("splag_ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
         
    # From WDI [Greatest hits]
    .with_column(Column("wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
        )
    .with_column(Column("wdi_dt_oda_odat_pc_zs", from_table = "wdi_cy", from_column = "wdi_dt_oda_odat_pc_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_ms_mil_xpnd_gd_zs", from_table = "wdi_cy", from_column = "wdi_ms_mil_xpnd_gd_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_se_enr_prsc_fm_zs", from_table = "wdi_cy", from_column = "wdi_se_enr_prsc_fm_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_maln_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_maln_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_totl_zs", from_table = "wdi_cy", from_column = "wdi_sm_pop_totl_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_0014_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_0014_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_1564_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_1564_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_grow", from_table = "wdi_cy", from_column = "wdi_sp_pop_grow")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_urb_totl_in_zs", from_table = "wdi_cy", from_column = "wdi_sp_urb_totl_in_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )


    # Spatial lags [Greatest hits]

    .with_column(Column("splag_wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )

         
         # From Vdem
    .with_column(Column("vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqdr", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqdr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xnp_client", from_table = "vdem_v11_cy", from_column = "vdem_v2xnp_client")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlpol", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlpol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("splag_vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
             .transform.missing.fill()
             .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
            )
    .with_column(Column("splag_vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )
    .with_column(Column("splag_vdem_v2x_accountability", from_table = "vdem_v11_cy", from_column = "vdem_v2x_accountability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
         
    # gwnos
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
            )
         
         

            .with_theme("fatalities")
            .describe("""Predicting ged_dummy_sb, cm level

                Queryset with many features from various sources, 'greatest hits'

            """)
        )
data = qs.publish().fetch()

print(f"fatalities002_greatest_hits; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# # Model with about 20 features
# Model with 20 or so most important predictors from several models

qs = (Queryset("hh_20_features", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   
 #
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
                 .transform.missing.fill()
                 .transform.missing.replace_na()
                )

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
         
    # More conflict history [hh20]
    .with_column(Column("ln_ged_sb_tlag_1", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(1)
                 .transform.missing.fill()
                )

    .with_column(Column("ln_ged_sb_tlag_2", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                 .transform.temporal.tlag(2)
                 .transform.missing.fill()
                )
    .with_column(Column("decay_acled_os_5", from_table = "acled2_cm", from_column = "acled_os_fat")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )                      
    .with_column(Column("decay_ged_sb_100", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(100)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )                     
    .with_column(Column("decay_ged_sb_500", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(500)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )   
                         
     # Features from reign [hh20]
    .with_column(Column("reign_tenure_months", from_table = "reign_cm", from_column = "tenure_months")
                 .transform.missing.fill()
                 .transform.missing.replace_na() 
                )
     
     
    # Features from topic model [hh20]
    .with_column(Column("ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta3_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                )
    .with_column(Column("ste_theta14_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta14_stock")
                 .transform.missing.fill()
                )

    # Spatial lags [hh20]
    .with_column(Column("splag_ste_theta11_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta11_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta2_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta2_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_ste_theta13_stock", from_table = "topic_model_shares_cm", from_column = "ste_theta13_stock")
                 .transform.missing.fill()
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
                         

    # From WDI [hh20]
    .with_column(Column("wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_nv_agr_totl_kn", from_table = "wdi_cy", from_column = "wdi_nv_agr_totl_kn")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sh_sta_maln_zs", from_table = "wdi_cy", from_column = "wdi_sh_sta_maln_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sm_pop_refg_or", from_table = "wdi_cy", from_column = "wdi_sm_pop_refg_or")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_dyn_imrt_in", from_table = "wdi_cy", from_column = "wdi_sp_dyn_imrt_in")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_0014_fe_zs", from_table = "wdi_cy", from_column = "wdi_sp_pop_0014_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("wdi_sp_pop_grow", from_table = "wdi_cy", from_column = "wdi_sp_pop_grow")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    # Spatial lags [hh20]

    .with_column(Column("splag_wdi_ag_lnd_frst_k2", from_table = "wdi_cy", from_column = "wdi_ag_lnd_frst_k2")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sl_tlf_totl_fe_zs", from_table = "wdi_cy", from_column = "wdi_sl_tlf_totl_fe_zs")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("splag_wdi_sm_pop_netm", from_table = "wdi_cy", from_column = "wdi_sm_pop_netm")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
         
         # From Vdem
    .with_column(Column("vdem_v2xcl_dmove", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_dmove")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xeg_eqdr", from_table = "vdem_v11_cy", from_column = "vdem_v2xeg_eqdr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlpol", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlpol")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
    .with_column(Column("vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
                         
    .with_column(Column("splag_vdem_v2xpe_exlsocgr", from_table = "vdem_v11_cy", from_column = "vdem_v2xpe_exlsocgr")
             .transform.missing.fill()
             .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
            )
    .with_column(Column("splag_vdem_v2xcl_rol", from_table = "vdem_v11_cy", from_column = "vdem_v2xcl_rol")
             .transform.missing.fill()
             .transform.temporal.tlag(12)
             .transform.spatial.countrylag(1,1,0,0)
             .transform.missing.replace_na()
                )


            .with_theme("fatalities")
            .describe("""Predicting ged_dummy_sb, cm level

                Queryset with many features from various sources, 'greatest hits'

            """)
        )
data = qs.publish().fetch()

print(f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# AQUASTAT


qs = (Queryset("Fatalities002_aquastat", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   
 #
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
                 .transform.missing.fill()
                 .transform.missing.replace_na()
                )

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
            )

     # From Aquastat
    .with_column(Column("agr_withdrawal_pct", from_table = "fao_aqua_cm", from_column = "agr_withdrawal_pct")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("fresh_withdrawal_pct", from_table = "fao_aqua_cm", from_column = "fresh_withdrawal_pct")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("general_efficiency", from_table = "fao_aqua_cm", from_column = "general_efficiency")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("groundwater_export", from_table = "fao_aqua_cm", from_column = "groundwater_export")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("ind_efficiency", from_table = "fao_aqua_cm", from_column = "ind_efficiency")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("irr_agr_efficiency", from_table = "fao_aqua_cm", from_column = "irr_agr_efficiency")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("renewable_internal_pcap", from_table = "fao_aqua_cm", from_column = "renewable_internal_pcap")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("renewable_pcap", from_table = "fao_aqua_cm", from_column = "renewable_pcap")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("services_efficiency", from_table = "fao_aqua_cm", from_column = "services_efficiency")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("water_stress", from_table = "fao_aqua_cm", from_column = "water_stress")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )
        

        .with_theme("production")
        .describe("""Production conflict history, cm level

    Predicting ged gte 25 with features from FAO aquastat
        """)
    )

data = qs.publish().fetch()

print(f"Fatalities002_aquastat; "
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


qs = (Queryset("Fatalities002_faostat", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   
 #
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
                 .transform.missing.fill()
                 .transform.missing.replace_na()
                )

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

     # From FAOstat
    .with_column(Column("consumer_prices_food_indices", from_table = "faostat_cpi_cm", from_column = "consumer_prices_food_indices")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("consumer_prices_general_indices", from_table = "faostat_cpi_cm", from_column = "consumer_prices_general_indices")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("food_price_inflation", from_table = "faostat_cpi_cm", from_column = "food_price_inflation")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("avg_adequate_diet", from_table = "faostat_fsec_cy", from_column = "avg_adequate_diet")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("avg_animalprotein_pcap_day", from_table = "faostat_fsec_cy", from_column = "avg_animalprotein_pcap_day")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("avg_fprod_value", from_table = "faostat_fsec_cy", from_column = "avg_fprod_value")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("avg_protein_pcap_day", from_table = "faostat_fsec_cy", from_column = "avg_protein_pcap_day")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("gdp_pc_ppp", from_table = "faostat_fsec_cy", from_column = "gdp_pc_ppp")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("kcal_pcap_day", from_table = "faostat_fsec_cy", from_column = "kcal_pcap_day")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("kcal_pcap_day_cerotu", from_table = "faostat_fsec_cy", from_column = "kcal_pcap_day_cerotu")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pcap_fprod_var", from_table = "faostat_fsec_cy", from_column = "pcap_fprod_var")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pcap_fsupply_var", from_table = "faostat_fsec_cy", from_column = "pcap_fsupply_var")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_arable_land", from_table = "faostat_fsec_cy", from_column = "pct_arable_land")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_cereal_import", from_table = "faostat_fsec_cy", from_column = "pct_cereal_import")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_fimport_merch", from_table = "faostat_fsec_cy", from_column = "pct_fimport_merch")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_modsevere_finsecurity", from_table = "faostat_fsec_cy", from_column = "pct_modsevere_finsecurity")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_pop_basicdrink", from_table = "faostat_fsec_cy", from_column = "pct_pop_basicdrink")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_pop_basicsani", from_table = "faostat_fsec_cy", from_column = "pct_pop_basicsani")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_pop_safedrink", from_table = "faostat_fsec_cy", from_column = "pct_pop_safedrink")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_pop_safesani", from_table = "faostat_fsec_cy", from_column = "pct_pop_safesani")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_severe_finsecurity", from_table = "faostat_fsec_cy", from_column = "pct_severe_finsecurity")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_und5_overweight", from_table = "faostat_fsec_cy", from_column = "pct_und5_overweight")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_und5_stunted", from_table = "faostat_fsec_cy", from_column = "pct_und5_stunted")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_und5_wasting", from_table = "faostat_fsec_cy", from_column = "pct_und5_wasting")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pct_undernourished", from_table = "faostat_fsec_cy", from_column = "pct_undernourished")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pol_stability", from_table = "faostat_fsec_cy", from_column = "pol_stability")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pop_modsevere_finsecurity", from_table = "faostat_fsec_cy", from_column = "pop_modsevere_finsecurity")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pop_severe_finsecurity", from_table = "faostat_fsec_cy", from_column = "pop_severe_finsecurity")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("pop_undernourished", from_table = "faostat_fsec_cy", from_column = "pop_undernourished")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("prev_adult_obesity", from_table = "faostat_fsec_cy", from_column = "prev_adult_obesity")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("prev_infant_bfeed", from_table = "faostat_fsec_cy", from_column = "prev_infant_bfeed")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("prev_lowbweight", from_table = "faostat_fsec_cy", from_column = "prev_lowbweight")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("prev_repr_anemia", from_table = "faostat_fsec_cy", from_column = "prev_repr_anemia")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 
    .with_column(Column("rail_density", from_table = "faostat_fsec_cy", from_column = "rail_density")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                ) 


        .with_theme("production")
        .describe("""Production conflict history, cm level

    Predicting ged gte 25 with features from FAOstat
        """)
    )

data = qs.publish().fetch()

print(f"Fatalities002_faostat;"
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )


# FAO prices

qs = (Queryset("Fatalities002_faoprices", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   
 #
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
                 .transform.missing.fill()
                 .transform.missing.replace_na()
                )

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
            )

     # From FAO food price data - prices and 12-month changes
    .with_column(Column("fao_wheat_price", from_table = "faostat_pp_cm", from_column = "wheat_price")
                 .transform.missing.replace_na(0)
                ) 
    .with_column(Column("delta_fao_wheat_price", from_table = "faostat_pp_cm", from_column = "wheat_price")
                 .transform.temporal.delta(12)
                 .transform.missing.replace_na(0)
                ) 
  
    .with_column(Column("fao_mp_price", from_table = "faostat_pp_cm", from_column = "mp_price")
                 .transform.missing.replace_na(0)
                ) 
    .with_column(Column("delta_fao_mp_price", from_table = "faostat_pp_cm", from_column = "mp_price")
                 .transform.temporal.delta(12)
                 .transform.missing.replace_na(0)
                ) 
  
    .with_column(Column("fao_sugar_price", from_table = "faostat_pp_cm", from_column = "sugar_price")
                 .transform.missing.replace_na(0)
                ) 
    .with_column(Column("delta_fao_sugar_price", from_table = "faostat_pp_cm", from_column = "sugar_price")
                 .transform.temporal.delta(12)
                 .transform.missing.replace_na(0)
                ) 
  
    .with_column(Column("fao_meat_price", from_table = "faostat_pp_cm", from_column = "meat_price")
                 .transform.missing.replace_na(0)
                ) 
    .with_column(Column("delta_fao_meat_price", from_table = "faostat_pp_cm", from_column = "meat_price")
                 .transform.temporal.delta(12)
                 .transform.missing.replace_na(0)
                ) 
  
    .with_column(Column("fao_milk_price", from_table = "faostat_pp_cm", from_column = "milk_price")
                 .transform.missing.replace_na(0)
                ) 
    .with_column(Column("delta_fao_milk_price", from_table = "faostat_pp_cm", from_column = "milk_price")
                 .transform.temporal.delta(12)
                 .transform.missing.replace_na(0)
                ) 
    # gwnos
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
            )

        .with_theme("production")
        .describe("""Production conflict history, cm level

    Predicting ged gte 25 with features from FAO food prices
        """)
    )

data = qs.publish().fetch()

print(f"Fatalities002_faoprices;"
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )

#IMF WEO

qs = (Queryset("Fatalities002_imfweo", "country_month")


    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   
 #
    .with_column(Column("gleditsch_ward", from_table = "country", from_column = "gwcode")
                 .transform.missing.fill()
                 .transform.missing.replace_na()
                )

    # Baseline features:
    # lag of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )
    .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                 .transform.missing.fill()
                 .transform.temporal.tlag(12)
                 .transform.missing.fill()
                )

      # IMF WEO
        .with_column(Column("imfweo_ngdp_rpch_tcurrent", from_table = "imfweo_cm", from_column = "ngdp_rpch_tcurrent")
                     .transform.missing.replace_na(0)
                    ) 
        .with_column(Column("imfweo_ngdp_rpch_tmin1", from_table = "imfweo_cm", from_column = "ngdp_rpch_tmin1")
                     .transform.missing.replace_na(0)
                    ) 
        .with_column(Column("imfweo_ngdp_rpch_tplus1", from_table = "imfweo_cm", from_column = "ngdp_rpch_tplus1")
                     .transform.missing.replace_na(0)
                    ) 
        .with_column(Column("imfweo_ngdp_rpch_tplus2", from_table = "imfweo_cm", from_column = "ngdp_rpch_tplus2")
                     .transform.missing.replace_na(0)
                    ) 
    

            .with_theme("production")
            .describe("""Production conflict history, cm level

        Predicting ged gte 25 with features from IMF/WEO growth forecasts
            """)
        )

data = qs.publish().fetch()

print(f"Fatalities002_imfweo;"
      f"A dataset with {len(data.columns)} columns, with "
      f"data between t {min(data.index.get_level_values(0))} "
      f"and {max(data.index.get_level_values(0))}. "
      f"({len(np.unique(data.index.get_level_values(1)))} units)"
     )




# GED, baseline, ln versions of predictors
# log variables

qs = (Queryset("hh_fat_cm_ged_ln_ultrashort", "country_month")

    # target variable
    .with_column(Column("ln_ged_sb_dep", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )                   

    # timelag 0 of target variable
    .with_column(Column("ln_ged_sb", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.ops.ln()
                 .transform.missing.fill()
                )
    # Decay functions
    # sb
    .with_column(Column("decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
     # os
    .with_column(Column("decay_ged_os_5", from_table = "ged2_cm", from_column = "ged_os_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.missing.replace_na()
                )
    # Spatial lag decay
    .with_column(Column("splag_1_decay_ged_sb_5", from_table = "ged2_cm", from_column = "ged_sb_best_sum_nokgi")
                 .transform.missing.replace_na()
                 .transform.bool.gte(5)
                 .transform.temporal.time_since()
                 .transform.temporal.decay(24)
                 .transform.spatial.countrylag(1,1,0,0)
                 .transform.missing.replace_na()
                )


     # From WDI
        .with_column(Column("wdi_sp_pop_totl", from_table = "wdi_cy", from_column = "wdi_sp_pop_totl")
                     .transform.missing.fill()
                     .transform.temporal.tlag(12)
                     .transform.missing.fill()
                    )

        .with_theme("fatalities")
        .describe("""Fatalities conflict history, cm level

            Predicting ln(fatalities) using conflict predictors, ultrashort

        """)
    )
#data = qs.publish().fetch()



